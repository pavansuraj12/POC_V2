<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Hen Detection – Stable</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body {
  margin: 0;
  background: black;
  color: white;
  font-family: Arial, sans-serif;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  height: 100vh;
}

#container {
  position: relative;
  width: 90vw;
  max-width: 720px;
  aspect-ratio: 4 / 3;
  background: black;
}

video, canvas {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
}

canvas {
  pointer-events: none;
}

#fps {
  position: absolute;
  top: 8px;
  left: 8px;
  color: #0f0;
  font-family: monospace;
  background: rgba(0,0,0,0.6);
  padding: 4px 6px;
}

#controls {
  margin-bottom: 10px;
}

button {
  padding: 10px 16px;
  font-size: 14px;
  cursor: pointer;
}
</style>
</head>

<body>

<div id="controls">
  <button onclick="start()">▶ Start Camera</button>
</div>

<div id="container">
  <video id="video" autoplay muted playsinline></video>
  <canvas id="canvas"></canvas>
  <div id="fps">FPS: --</div>
</div>

<script>
/* ================= CONFIG ================= */
const WS_URL = "wss://unraided-camren-streamingly.ngrok-free.dev";
const MODEL_INPUT_SIZE = 960;

/* ================= GLOBALS ================= */
const video = document.getElementById("video");
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");
const fpsLabel = document.getElementById("fps");

let socket = null;
let detections = [];
let videoW = 0;
let videoH = 0;
let lastTime = performance.now();
let started = false;

/* ================= START (USER GESTURE) ================= */
async function start() {
  if (started) return;
  started = true;

  await startCamera();
  startWebSocket();
}

/* ================= CAMERA ================= */
async function startCamera() {
  try {
    const stream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: { ideal: "environment" } },
      audio: false
    });

    video.srcObject = stream;

    video.onloadedmetadata = () => {
      videoW = video.videoWidth;
      videoH = video.videoHeight;

      canvas.width = videoW;
      canvas.height = videoH;

      requestAnimationFrame(renderLoop);
    };

  } catch (err) {
    alert("Camera error: " + err.message);
    console.error(err);
  }
}

/* ================= WEBSOCKET ================= */
function startWebSocket() {
  socket = new WebSocket(WS_URL);

  socket.onopen = () => {
    console.log("WebSocket connected");
  };

  socket.onerror = e => {
    console.error("WebSocket error", e);
  };

  socket.onmessage = e => {
    detections = JSON.parse(e.data).detections || [];
  };
}

/* ================= SEND FRAME ================= */
function sendFrame() {
  if (!socket || socket.readyState !== 1) return;

  const tmp = document.createElement("canvas");
  tmp.width = MODEL_INPUT_SIZE;
  tmp.height = MODEL_INPUT_SIZE;

  tmp.getContext("2d").drawImage(video, 0, 0, MODEL_INPUT_SIZE, MODEL_INPUT_SIZE);

  socket.send(JSON.stringify({
    frame: tmp.toDataURL("image/jpeg", 0.7).split(",")[1]
  }));
}

/* ================= RENDER LOOP ================= */
function renderLoop(now) {
  ctx.clearRect(0, 0, canvas.width, canvas.height);

  const sx = canvas.width / MODEL_INPUT_SIZE;
  const sy = canvas.height / MODEL_INPUT_SIZE;

  detections.forEach(d => {
    ctx.strokeStyle = "lime";
    ctx.lineWidth = 2;
    ctx.strokeRect(
      d.x1 * sx,
      d.y1 * sy,
      (d.x2 - d.x1) * sx,
      (d.y2 - d.y1) * sy
    );
  });

  const fps = Math.round(1000 / (now - lastTime));
  lastTime = now;
  fpsLabel.innerText = `FPS: ${fps}`;

  sendFrame();
  requestAnimationFrame(renderLoop);
}
</script>

</body>
</html>
